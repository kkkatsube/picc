# Canvas機能 データモデル仕様書

## 概要
Picboardアプリケーションのデータ構造をLaravel + React環境に移植する仕様書。
既存の「Picboard」を「Canvas」として再定義し、画像配置・公開共有機能を実装する。

---

## 前提条件
- Userモデルは既存（Laravelの認証システム実装済み）
- データベース: MySQL 8.0+（utf8mb4対応）
- Laravel 10.x以上を想定

---

## 1. テーブル定義

### 1.1 canvases テーブル

**用途**: ユーザーが作成する画像配置用キャンバス

| カラム名 | 型 | 属性 | 説明 |
|---------|-----|------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | キャンバスID |
| user_id | BIGINT UNSIGNED | NOT NULL, INDEX, FOREIGN KEY | 所有者（Userテーブル参照） |
| name | VARCHAR(255) | NULLABLE | キャンバス名 |
| memo | TEXT | NULLABLE | メモ・説明文 |
| width | INT | NULLABLE | キャンバス幅（px） |
| height | INT | NULLABLE | キャンバス高さ（px） |
| created_at | TIMESTAMP | NOT NULL | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | 更新日時 |

**インデックス**:
- PRIMARY KEY: `id`
- INDEX: `user_id`

**外部キー制約**:
- `user_id` → `users.id` (ON DELETE CASCADE)

---

### 1.2 canvas_images テーブル

**用途**: キャンバス上に配置された画像の情報

| カラム名 | 型 | 属性 | 説明 |
|---------|-----|------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | 画像レコードID |
| canvas_id | BIGINT UNSIGNED | NOT NULL, INDEX, FOREIGN KEY | 所属キャンバス |
| uri | VARCHAR(2048) | NOT NULL | 画像URL |
| x | INT | NULLABLE | キャンバス上のX座標 |
| y | INT | NULLABLE | キャンバス上のY座標 |
| width | INT | NULLABLE | 表示幅（px） |
| height | INT | NULLABLE | 表示高さ（px） |
| left | INT | NULLABLE | クロッピング左オフセット |
| right | INT | NULLABLE | クロッピング右オフセット |
| top | INT | NULLABLE | クロッピング上オフセット |
| bottom | INT | NULLABLE | クロッピング下オフセット |
| size | FLOAT | NULLABLE | 表示倍率 |
| created_at | TIMESTAMP | NOT NULL | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | 更新日時 |

**インデックス**:
- PRIMARY KEY: `id`
- INDEX: `canvas_id`

**外部キー制約**:
- `canvas_id` → `canvases.id` (ON DELETE CASCADE)

---

### 1.3 canvas_shares テーブル

**用途**: キャンバス公開共有用のハッシュリンク管理

| カラム名 | 型 | 属性 | 説明 |
|---------|-----|------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | 共有レコードID |
| canvas_id | BIGINT UNSIGNED | NOT NULL, UNIQUE, INDEX, FOREIGN KEY | 対象キャンバス |
| hash | VARCHAR(255) | NOT NULL, UNIQUE, INDEX | 公開用ハッシュ文字列 |
| created_at | TIMESTAMP | NOT NULL | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | 更新日時 |

**インデックス**:
- PRIMARY KEY: `id`
- UNIQUE INDEX: `canvas_id`
- UNIQUE INDEX: `hash`

**外部キー制約**:
- `canvas_id` → `canvases.id` (ON DELETE CASCADE)

---

## 2. リレーションシップ定義

### User ↔ Canvas
- **User**: `hasMany(Canvas::class)` - 1ユーザーは複数のキャンバスを所有
- **Canvas**: `belongsTo(User::class)` - 1キャンバスは1ユーザーに所属

### Canvas ↔ CanvasImage
- **Canvas**: `hasMany(CanvasImage::class)` - 1キャンバスには複数の画像
- **CanvasImage**: `belongsTo(Canvas::class)` - 1画像は1キャンバスに所属

### Canvas ↔ CanvasShare
- **Canvas**: `hasOne(CanvasShare::class)` - 1キャンバスは最大1つの共有設定
- **CanvasShare**: `belongsTo(Canvas::class)` - 1共有設定は1キャンバスに紐づく

---

## 3. Laravelマイグレーションファイル例

### 3.1 canvases テーブル

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('canvases', function (Blueprint $table) {
            $table->id();
            $table->foreignId('user_id')
                  ->constrained()
                  ->onDelete('cascade');
            $table->string('name')->nullable();
            $table->text('memo')->nullable();
            $table->integer('width')->nullable();
            $table->integer('height')->nullable();
            $table->timestamps();

            $table->index('user_id');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('canvases');
    }
};
```

### 3.2 canvas_images テーブル

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('canvas_images', function (Blueprint $table) {
            $table->id();
            $table->foreignId('canvas_id')
                  ->constrained('canvases')
                  ->onDelete('cascade');
            $table->string('uri', 2048);
            $table->integer('x')->nullable();
            $table->integer('y')->nullable();
            $table->integer('width')->nullable();
            $table->integer('height')->nullable();
            $table->integer('left')->nullable();
            $table->integer('right')->nullable();
            $table->integer('top')->nullable();
            $table->integer('bottom')->nullable();
            $table->float('size')->nullable();
            $table->timestamps();

            $table->index('canvas_id');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('canvas_images');
    }
};
```

### 3.3 canvas_shares テーブル

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('canvas_shares', function (Blueprint $table) {
            $table->id();
            $table->foreignId('canvas_id')
                  ->unique()
                  ->constrained('canvases')
                  ->onDelete('cascade');
            $table->string('hash')->unique();
            $table->timestamps();

            $table->index('canvas_id');
            $table->index('hash');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('canvas_shares');
    }
};
```

---

## 4. Eloquentモデル定義例

### 4.1 Canvas.php

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\Relations\HasMany;
use Illuminate\Database\Eloquent\Relations\HasOne;

class Canvas extends Model
{
    use HasFactory;

    protected $fillable = [
        'user_id',
        'name',
        'memo',
        'width',
        'height',
    ];

    protected $casts = [
        'width' => 'integer',
        'height' => 'integer',
    ];

    /**
     * 所有ユーザー
     */
    public function user(): BelongsTo
    {
        return $this->belongsTo(User::class);
    }

    /**
     * 配置画像一覧
     */
    public function images(): HasMany
    {
        return $this->hasMany(CanvasImage::class);
    }

    /**
     * 公開共有設定
     */
    public function share(): HasOne
    {
        return $this->hasOne(CanvasShare::class);
    }
}
```

### 4.2 CanvasImage.php

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

class CanvasImage extends Model
{
    use HasFactory;

    protected $fillable = [
        'canvas_id',
        'uri',
        'x',
        'y',
        'width',
        'height',
        'left',
        'right',
        'top',
        'bottom',
        'size',
    ];

    protected $casts = [
        'x' => 'integer',
        'y' => 'integer',
        'width' => 'integer',
        'height' => 'integer',
        'left' => 'integer',
        'right' => 'integer',
        'top' => 'integer',
        'bottom' => 'integer',
        'size' => 'float',
    ];

    /**
     * 所属キャンバス
     */
    public function canvas(): BelongsTo
    {
        return $this->belongsTo(Canvas::class);
    }
}
```

### 4.3 CanvasShare.php

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Support\Str;

class CanvasShare extends Model
{
    use HasFactory;

    protected $fillable = [
        'canvas_id',
        'hash',
    ];

    /**
     * 所属キャンバス
     */
    public function canvas(): BelongsTo
    {
        return $this->belongsTo(Canvas::class);
    }

    /**
     * ユニークなハッシュ生成
     */
    public static function generateUniqueHash(): string
    {
        do {
            $hash = Str::random(32);
        } while (self::where('hash', $hash)->exists());

        return $hash;
    }
}
```

### 4.4 User.php（追加リレーション）

```php
// 既存のUserモデルに以下を追加

/**
 * 所有キャンバス一覧
 */
public function canvases(): HasMany
{
    return $this->hasMany(Canvas::class);
}
```

---

## 5. データ仕様の補足説明

### 5.1 画像配置プロパティ

| プロパティ | 用途 | 値の範囲 |
|-----------|------|----------|
| x, y | キャンバス上の配置座標 | 0 ~ canvas.width/height |
| width, height | 画像の表示サイズ | 1 ~ 元画像サイズ |
| left, right, top, bottom | クロッピングオフセット | 0 ~ 元画像サイズ |
| size | 表示倍率 | 0.1 ~ 10.0（推奨） |

### 5.2 ハッシュ生成仕様
- **文字数**: 32文字
- **文字種**: 英数字（ランダム）
- **重複チェック**: 生成時に既存ハッシュと照合
- **用途**: `/share/{hash}` のような公開URL生成

### 5.3 CASCADE削除の挙動
- **Userが削除** → 所有Canvas全削除 → 配下のCanvasImage, CanvasShare全削除
- **Canvasが削除** → 配下のCanvasImage, CanvasShare全削除

---

## 6. マイグレーション実行順序

```bash
# 1. Userテーブル（既存）
php artisan migrate:fresh # または既存マイグレーション

# 2. Canvasesテーブル
php artisan make:migration create_canvases_table
php artisan migrate

# 3. CanvasImagesテーブル
php artisan make:migration create_canvas_images_table
php artisan migrate

# 4. CanvasSharesテーブル
php artisan make:migration create_canvas_shares_table
php artisan migrate
```

---

## 7. 移行時の注意点

### 7.1 テーブル名の変更
| Rails | Laravel |
|-------|---------|
| picboards | canvases |
| images | canvas_images |
| openboards | canvas_shares |

### 7.2 命名規約の違い
- **Rails**: 単数形モデル名 + 複数形テーブル名
- **Laravel**: 同様だが、外部キーは `model_id` 形式が標準

### 7.3 データ型の差異
- **Rails `text`** → **Laravel `text()`**: 同等
- **Rails `string`** → **Laravel `string(length)`**: 最大長指定推奨
- **Rails `float`** → **Laravel `float()`**: 同等

---

この仕様書をもとにマイグレーションファイルとモデルを実装すれば、現行のPicboard機能をLaravel環境に移植できます。
